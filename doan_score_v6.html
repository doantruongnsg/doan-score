<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý điểm phong trào Đoàn</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        select, input, button { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: none; }
        #history { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #exportBtn { background-color: #008CBA; }
        #exportBtn:hover { background-color: #007B9A; }
        #uploadBtn { background-color: #FF9800; }
        #uploadBtn:hover { background-color: #F57C00; }
        #confirmUpload { display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; }
        #confirmBtn { background-color: #2196F3; }
        #confirmBtn:hover { background-color: #1976D2; }
        #cancelBtn { background-color: #f44336; }
        #cancelBtn:hover { background-color: #d32f2f; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Quản lý điểm phong trào Đoàn</h1>
        <form id="scoreForm">
            <label for="className">Tên lớp:</label>
            <input type="text" id="className" name="className" required placeholder="Ví dụ: CNTT K21">
            <label for="movementName">Tên phong trào:</label>
            <input type="text" id="movementName" name="movementName" required placeholder="Ví dụ: Mùa hè xanh">
            <label for="date">Ngày tham gia:</label>
            <input type="date" id="date" name="date" required>
            <label for="participants">Tên người tham gia:</label>
            <input type="text" id="participants" name="participants" placeholder="Ví dụ: Nguyễn Văn A, Trần Thị B">
            <label for="level">Cấp phong trào:</label>
            <select id="level" name="level">
                <option value="Thành Đoàn">Thành Đoàn (15 điểm)</option>
                <option value="Quận Đoàn">Quận Đoàn (12 điểm)</option>
                <option value="Đoàn trường">Đoàn trường (10 điểm)</option>
            </select>
            <label for="required">Số người điều động:</label>
            <input type="number" id="required" name="required" min="1" required>
            <label for="attended">Số người tham gia:</label>
            <input type="number" id="attended" name="attended" min="0" required>
            <button type="button" onclick="calculateAndSave()">Tính và lưu điểm</button>
        </form>

        <div id="result">
            <h3>Kết quả</h3>
            <p>Phong trào: <span id="resultMovement"></span></p>
            <p>Ngày tham gia: <span id="resultDate"></span></p>
            <p>Người tham gia: <span id="resultParticipants"></span></p>
            <p>Điểm tỷ lệ: <span id="ratioScore"></span></p>
            <p>Xếp loại: <span id="ranking"></span></p>
            <p><strong>Tổng điểm: <span id="totalScore"></span></strong></p>
            <p><em>*Xếp loại: Xuất sắc (≥90%), Tốt (70% - dưới 90%), Đạt (50% - dưới 70%), Không đạt (<50%)</em></p>
        </div>

        <div id="history">
            <h3>Lịch sử phong trào</h3>
            <input type="file" id="uploadFile" accept=".xlsx, .xls" style="display: none;" onchange="previewUpload(event)">
            <button id="uploadBtn" type="button" onclick="document.getElementById('uploadFile').click()">Upload danh sách</button>
            <button id="exportBtn" type="button" onclick="exportToExcel()">Xuất file Excel</button>
            <div id="confirmUpload">
                <p>Đã chọn file: <span id="fileName"></span></p>
                <p>Số người tham gia: <span id="rowCount"></span></p>
                <button id="confirmBtn" type="button" onclick="confirmUpload()">Xác nhận</button>
                <button id="cancelBtn" type="button" onclick="cancelUpload()">Hủy</button>
            </div>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Lớp</th>
                        <th>Phong trào</th>
                        <th>Ngày</th>
                        <th>Người tham gia</th>
                        <th>Cấp</th>
                        <th>Tham gia/Điều động</th>
                        <th>Tổng điểm</th>
                        <th>Xếp loại</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const levels = {
            "Thành Đoàn": { max: 15, ratio: 15 },
            "Quận Đoàn": { max: 12, ratio: 12 },
            "Đoàn trường": { max: 10, ratio: 10 }
        };

        function calculateScore(className, level, required, attended) {
            const config = levels[level];
            let ratioScore = Math.min((attended / required) * config.ratio, config.ratio);
            const total = ratioScore;
            let ranking;
            const percentage = (total / config.max) * 100;
            if (percentage >= 90) ranking = "Xuất sắc (≥90%)";
            else if (percentage >= 70) ranking = "Tốt (70% - dưới 90%)";
            else if (percentage >= 50) ranking = "Đạt (50% - dưới 70%)";
            else ranking = "Không đạt (<50%)";
            return { ratioScore, total, ranking };
        }

        function calculateAndSave() {
            const className = document.getElementById("className").value;
            const movementName = document.getElementById("movementName").value;
            const date = document.getElementById("date").value;
            const participants = document.getElementById("participants").value || "Không ghi nhận";
            const level = document.getElementById("level").value;
            const required = parseInt(document.getElementById("required").value);
            const attended = parseInt(document.getElementById("attended").value);

            if (!className || !movementName || !date || isNaN(required) || isNaN(attended)) {
                alert("Vui lòng điền đầy đủ thông tin!");
                return;
            }

            const scores = calculateScore(className, level, required, attended);

            document.getElementById("resultMovement").textContent = movementName;
            document.getElementById("resultDate").textContent = date;
            document.getElementById("resultParticipants").textContent = participants;
            document.getElementById("ratioScore").textContent = scores.ratioScore.toFixed(1);
            document.getElementById("ranking").textContent = scores.ranking;
            document.getElementById("totalScore").textContent = scores.total.toFixed(1) + " / " + levels[level].max;
            document.getElementById("result").style.display = "block";

            let history = JSON.parse(localStorage.getItem("doanHistory") || "[]");
            history.push({ className, movementName, date, participants, level, required, attended, total: scores.total, ranking: scores.ranking });
            localStorage.setItem("doanHistory", JSON.stringify(history));
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const history = JSON.parse(localStorage.getItem("doanHistory") || "[]");
            const tbody = document.getElementById("historyBody");
            tbody.innerHTML = "";
            history.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.className}</td>
                    <td>${item.movementName}</td>
                    <td>${item.date}</td>
                    <td>${item.participants}</td>
                    <td>${item.level}</td>
                    <td>${item.attended}/${item.required}</td>
                    <td>${item.total.toFixed(1)}</td>
                    <td>${item.ranking}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportToExcel() {
            const history = JSON.parse(localStorage.getItem("doanHistory") || "[]");
            if (history.length === 0) {
                alert("Chưa có dữ liệu để xuất!");
                return;
            }

            const data = [
                ["Lớp", "Phong trào", "Ngày", "Người tham gia", "Cấp", "Tham gia/Điều động", "Tổng điểm", "Xếp loại"],
                ...history.map(item => [
                    item.className, item.movementName, item.date, item.participants, item.level,
                    `${item.attended}/${item.required}`, item.total.toFixed(1), item.ranking
                ])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;
                    ws[cell_ref].s = { font: { name: "Times New Roman", sz: 13 } };
                }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DoanHistory");
            XLSX.writeFile(wb, "doan_history.xlsx");
        }

        let uploadedData = null;

        function previewUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length < 2) {
                    alert("File Excel rỗng hoặc không có dữ liệu!");
                    return;
                }

                const headers = jsonData[0];
                if (headers.length !== 1 || headers[0] !== "Họ tên") {
                    alert("File Excel phải có duy nhất một cột 'Họ tên'!");
                    return;
                }

                const participants = jsonData.slice(1).map(row => row[0]).filter(name => name);
                uploadedData = participants;

                document.getElementById("fileName").textContent = file.name;
                document.getElementById("rowCount").textContent = participants.length;
                document.getElementById("confirmUpload").style.display = "block";
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmUpload() {
            if (!uploadedData) return;

            const className = document.getElementById("className").value || "Lớp mặc định";
            const movementName = document.getElementById("movementName").value || "Phong trào mặc định";
            const date = document.getElementById("date").value || "2025-03-20";
            const level = document.getElementById("level").value || "Đoàn trường";
            const required = parseInt(document.getElementById("required").value) || 10;
            const attended = uploadedData.length; // Số người tham gia = số tên trong file

            let history = JSON.parse(localStorage.getItem("doanHistory") || "[]");

            uploadedData.forEach(participant => {
                const scores = calculateScore(className, level, required, attended);
                history.push({
                    className,
                    movementName,
                    date,
                    participants: participant,
                    level,
                    required,
                    attended,
                    total: scores.total,
                    ranking: scores.ranking
                });
            });

            localStorage.setItem("doanHistory", JSON.stringify(history));
            updateHistoryTable();
            alert("Đã upload danh sách thành công!");
            cancelUpload();
        }

        function cancelUpload() {
            uploadedData = null;
            document.getElementById("confirmUpload").style.display = "none";
            document.getElementById("uploadFile").value = "";
        }

        window.onload = updateHistoryTable;
    </script>
</body>
</html>
